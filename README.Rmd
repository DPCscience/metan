---
always_allow_html: yes
output: github_document

---

<!-- README.md is generated from README.Rmd. Please edit that file -->


# metan <img src="man/figures/logo.png" align="right" height=140/>

The metan (**m**ulti-**e**nvironment **t**rials **an**alysis) package provides useful functions for analyzing multi-environment trial data using parametric and nonparametric methods, including, but not limited to:

* Within-environment analysis of variance;
* Estimation using AMMI considering different numbers of interaction principal component axes;
* AMMI-based stability indexes;
* GGE biplot analysis;
* Prediction in mixed-effect models;
* BLUP-based stability indexes;
* Variance components and genetic parameters in mixed-effect models;
* Cross-validation procedures for AMMI-family and BLUP models;
* Graphics tools for generating biplots;
* Parametric and nonparametric stability statistics

For more details see the [complete vignette](https://tiagoolivoto.github.io/metan/).

# Installation

The latest development version can be download from GitHub by running
```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("TiagoOlivoto/metan")
```



# Brief examples

The `metan` contains some datasets for examples. We will use the example `data_ge` that contains data from two variables assessed in 10 genotypes growing in 14 environments. For more details see `?data_ge`

```{r, message=FALSE, warning=FALSE}
library(metan)
library(ggplot2) # used to create the plots
library(cowplot) # used to arrange the plots
str(data_ge)

```


## AMMI model
### Fitting the model
The AMMI model is fitted with the function `waas()`. For more details, see the [complete vignette](https://tiagoolivoto.github.io/metan/articles/vignettes_ammi.html).

```{r}
model <- waas(data_ge,
              resp = GY,
              gen = GEN,
              env = ENV,
              rep = REP,
              verbose = FALSE)
```


### Predicting the response variable
The S3 method `predict()` is implemented for objects of class `waas` and may be used to estimate the response of each genotype in each environment considering different number of Interaction Principal Component Axis (IPCA). For example, we will use four IPCA (number of significant IPCAs) to estimate the variable GY using the `model` object.

```{r message=FALSE,warning=FALSE }
library(kableExtra)
predicted = predict(model, naxis = 4)
kable(predicted$GY[1:5,], "html", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "condensed", "responsive"))
```


### Biplots

ggplot2-based graphics are easily obtained in metan package. For example, the well-known AMMI2 biplot may be obtained as follows. Please, note that since `waas()` function allows analyzing multiple variables at the same time, e.g., `resp = c(v1, v2, ...)`, the output `model` is a list, in this case with one element, GY.

```{r, fig.width = 10, fig.align = "center", message=FALSE, warning=FALSE}
p1 = plot_scores(model$GY, axis.expand = 1.5)
p2 = plot_scores(model$GY,
                 type = 1,
                 polygon = TRUE,
                 col.gen = "black",
                 col.env = "gray70",
                 col.segm.env = "gray70",
                 axis.expand = 1.5)
plot_grid(p1, p2, labels = c("p1","p2"))
```

## GGE model
The GGE model is fitted with the function `gge()`. For more details, see the [complete vignette](https://tiagoolivoto.github.io/metan/articles/vignettes_gge.html).


```{r, fig.width = 10, fig.align = "center", message=FALSE, warning=FALSE}
model <- gge(data_ge, ENV, GEN, GY)
model2 <- gge(data_ge, ENV, GEN, GY, svp = "symmetrical")
p1 <- plot(model)
p2 <- plot(model2,
           type = 2,
           col.gen = "black",
           col.env = "gray70",
           axis.expand = 1.5)
plot_grid(p1, p2, labels = c("p1","p2"))
```


## BLUP model
The implementation of linear-mixed effect models to predict the response variable in MET is based on the `waasb()` function. For more details, see the [complete vignette](https://tiagoolivoto.github.io/metan/articles/vignettes_blup.html).

```{r }
model2 <- waasb(data_ge,
                resp = GY,
                gen = GEN,
                env = ENV,
                rep = REP,
                verbose = FALSE)
```


### Plotting the BLUPs for genotypes


```{r, fig.width = 10, fig.align = "center"}
p1 = plot_blup(model2$GY)
p2 = plot_blup(model2$GY,
               prob = 0.1,
               col.shape  =  c("gray20", "gray80")) + coord_flip()
plot_grid(p1, p2, labels = c("p1", "p2"))
```


### BLUPS for genotype-vs-environment interaction

```{r }
data = model2$GY$BLUPgge[1:5,]
kable(data, "html", digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "condensed", "responsive"))
```


# Getting help

* If you encounter a clear bug, please file a minimal reproducible example on [github](https://github.com/TiagoOlivoto/metan/issues)

* Suggestions and criticisms to improve the quality and usability of the package are welcome!



