---
title: "Parametric and non-parametric stability statistics"
author: "Tiago Olivoto"
date: "`r Sys.Date()`"
always_allow_html: yes
output: rmarkdown::html_vignette
fig_caption: yes
link-citations: true
bibliography: metanref.bib    
vignette: >
  %\VignetteIndexEntry{Parametric and non-parametric stability statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(comment = "")

```


# Getting started

In this section, we will use the data in `data_ge` and `data_ge2`. For more information see `?data_ge` and `?data_ge2`, respectively. Other data sets can be used provided that the following columns are in the data_ge: environment, genotype, block/replicate and response variable(s). The R package [`kableExtra`](http://haozhu233.github.io/kableExtra/awesome_table_in_html.html) was used to produce the tables of this vignette.

```{r, warning=FALSE, message=FALSE}
library(metan)
```


```{r, echo=FALSE}
library(kableExtra) # Used to make the tables
library(tidyverse) # for data manipulation and pipe %>%
# Function to make HTML tables
print_table = function(table){
  kable(table, "html", digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
}
str(data_ge)

```



# Graphic visualization of the interaction
The function `ge_plot()` may be used to visualize the genotype's performance across the environments. The black diamond shows the mean for each environment.
```{r, fig.width=10, fig.height=5, warning = FALSE, message = FALSE}
a <- ge_plot(data_ge, ENV, GEN, GY)
b <- ge_plot(data_ge, ENV, GEN, GY) + coord_flip()
arrange_ggplot(a, b, labels = letters[1:2])
```


# Within-environment analysis of variance
The function `anova_ind()` can be used to compute an within-environment analysis of variance. Environment with values in blue had a significant (p < 0.05) genotype effect.

```{r eval=FALSE}
ind <- anova_ind(data_ge, ENV, GEN, REP, GY)
ind

```


```{r echo=FALSE }
ind <- anova_ind(data_ge, ENV, GEN, REP, GY)
kable(ind$GY$individual, "html", digits = 3) %>% 
  row_spec(which(ind$GY$individual$PRFG < 0.05), bold = T, color = "blue") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```

# Genotype-by-environment means
The function `make_mat()` can be used to produce a two-way table for the genotype-environment means.

```{r eval = FALSE }
make_mat(data_ge, GEN, ENV, GY) %>% 
round(3) 
```


```{r echo=FALSE}
make_mat(data_ge, GEN, ENV, GY) %>% 
  round(3) %>% 
rownames_to_column('gen') %>% 
mutate_if(is.numeric, function(x){
  cell_spec(x, "html",
            color = case_when(x == max(x) ~ "white",
                              x == min(x) ~ "white",
                              TRUE ~ "black"),
            background  = case_when(x == max(x) ~ "green",
                                    x == min(x) ~ "red",
                                    TRUE ~ "transparent"))
}) %>%
kable("html", digits = 3, escape = F) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```


# Genotype-by-environment interaction effects
The function `ge_effects()` is used to compute the genotype-environment effects. Herem we highlight with a red background the genotypes with negative interaction effects within each environment
```{r eval=FALSE}
ge_ef <- ge_effects(data_ge, ENV, GEN, REP, GY)
round(ge_ef$GY, 2)

```

```{r echo= FALSE}

ge_ef <- ge_effects(data_ge, ENV, GEN, REP, GY)
  round(ge_ef$GY, 2) %>% 
  rownames_to_column('gen') %>%
  mutate_if(is.numeric, function(x){
    cell_spec(x, "html",
              color = ifelse(x < 0, "white", "black"),
              background  = ifelse(x < 0, "red", "transparent"))
  }) %>%
  kable("html", digits = 3, escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```



# Genotype plus Genotype-by-environment effects
```{r eval=FALSE }
gge_ef <- ge_effects(data_ge, ENV, GEN, REP, GY, type = "gge")
round(gge_ef$GY, 2)
```

```{r echo = FALSE}
gge_ef <- ge_effects(data_ge, ENV, GEN, REP, GY, type = "gge")
  round(gge_ef$GY, 2) %>% 
  rownames_to_column('gen') %>% 
  mutate_if(is.numeric, function(x){
    cell_spec(x, "html",
              color = ifelse(x < 0, "white", "black"),
              background  = ifelse(x < 0, "red", "transparent"))
  }) %>%
  kable("html", digits = 3, escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```



# Clustering tester locations

The function `ge_cluster()` computes a cluster analysis for grouping environments based on its similarities using an Euclidean distance based on standardized data. Line means are divided by the phenotypic standard error of the relevant environment after its mean has been subtracted. By standardizing the data each environment will have a mean of zero and unit variance, and the effect of variability in phenotypic variance (as well as the mean) should be reduced [@Fox1982].

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE, fig.align="center"}
d1 = ge_cluster(data_ge, ENV, GEN, GY, nclust = 4)
plot(d1, nclust = 4)

```


# Joint regression analysis
@Eberhart1966 popularized the regression-based stability analysis. In these procedures, the adaptability and stability analysis is performed by means of adjustments of regression equations where the dependent variable is predicted as a function of an environmental index, according to the following model:

$$
\mathop Y\nolimits_{ij}  = {\beta _{0i}} + {\beta _{1i}}{I_j} + {\delta _{ij}} + {\bar \varepsilon _{ij}}
$$
where ${\beta _{0i}}$ is the grand mean of the genotype *i* (*i* = 1, 2, ..., I); ${\beta _{1i}}$ is the linear response (slope) of the genotype *i* to the environmental index; *Ij* is the environmental index (*j* = 1, 2, ..., *e*), where ${I_j} = [(y_{.j}/g)- (y_{..}/ge)]$, ${\delta _{ij}}$ is the deviation from the regression, and ${\bar \varepsilon _{ij}}$ is the experimental error.
The model is fitted with the function `ge_reg()`. The S3 methods `plot()` and `summary()` may be used to explore the fitted model.

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
reg_model <- ge_reg(data_ge, ENV, GEN, REP, GY)
print_table(reg_model$GY$anova)
print_table(reg_model$GY$regression)

```


# Genotypic confidence index
@Annicchiarico1992 proposed a stability method in which the stability parameter is measured by the superiority of the genotype in relation to the average of each environment, according to the following model:

$$
{Z_{ij}} = \frac{{{Y_{ij}}}}{{{{\bar Y}_{.j}}}} \times 100
$$
The genotypic confidence index of the genotype *i* ($W_i$) is then estimated as follows:

$$
W_i = Z_{i.}/e - \alpha \times sd(Z_{i.})
$$
Where $\alpha$ is the quantile of the standard normal distribution at a given probability error ($\alpha \approx 1.64$ at 0.05). The method is implemented using the function `Annicchiarico()`. The confidence index is estimated considering all environment, favorable environments (positive index) and unfavorable environments (negative index), as follows:

## Computing the index

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
ann5 <- Annicchiarico(data_ge, ENV, GEN, REP, GY)
ann1 <- Annicchiarico(data_ge, ENV, GEN, REP, GY, prob = 0.01)


```

## Environment classification

```{r, eval=FALSE}
ann5$GY$environments

```

```{r, echo = FALSE}
df = ann5$GY$environments
kable(df, "html", digits = 3) %>% 
row_spec(which(df$index <0), bold = T, color = "white", background = "red") %>%
row_spec(which(df$index >0), bold = T, color = "white", background = "green") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```


## Index computed with all environments

```{r, eval = FALSE}
ann5$GY$general

```

```{r, echo=FALSE}
kable(ann5$GY$general, "html", digits = 3) %>% 
row_spec(2, bold = T, color = "white", background = "red") %>%
row_spec(4, bold = T, color = "white", background = "green") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```


# Superiority index
The function `superiority()` implements the nonparametric method proposed by @Lin1988, which considers that a measure of cultivar general superiority for cultivar x location data is defined as the distance mean square between the cultivar's response and the maximum response averaged over all locations, according to the following model.

$$
P_i = \sum\limits_{j = 1}^n{(y_{ij} - y_{.j})^2/(2n)}
$$
where *n* is the number of environments

Similar then the genotypic confidence index, the superiority index is calculated by all environments, favorable, and unfavorable environments.

```{r, eval=FALSE}
super <- superiority(data_ge, ENV, GEN, REP, GY)
super$GY$index
```


```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE, echo=FALSE}
super = superiority(data_ge, ENV, GEN, REP, GY)

kable(super$GY$index, "html", digits = 3) %>% 
  row_spec(2, bold = T, color = "white", background = "red") %>%
  row_spec(4, bold = T, color = "white", background = "green") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```


# Environmental stratification
A method that combines stability analysis and environmental stratification using factor analysis was proposed by @murakami2004. This method is implemented with the function `ge_factanal()`, as follows:

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
fact <- ge_factanal(data_ge, ENV, GEN, REP, GY)
plot(fact)
fact$GY$PCA
fact$GY$FA
fact$GY$env_strat

```

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
fact = ge_factanal(data_ge, ENV, GEN, REP, GY)
plot(fact)
print_table(fact$GY$PCA)
print_table(fact$GY$FA)
print_table(fact$GY$env_strat)

```


The easiest way to compute the above-mentioned stability indexes is by using the function `ge_stats()`. It is a wrapper function that computes all the stability indexes at once. To get the results into a *"ready-to-read"* file, use `get_model_data()`.



# Wrapper function

```{r }
stat_ge <- data_ge2 %>% ge_stats(ENV, GEN, REP, resp = c(EH, EP))
get_model_data(stat_ge, "stats")
get_model_data(stat_ge, "ranks")

```

It is also possible to obtain the Spearman's rank correlation between the stability indexes by using `corr_stab_ind()`.

```{r fig.width=10, fig.height=10}
corr_stab_ind(stat_ge)
```




# References

