---
title: "Utilities for data manipulation"
author: "Tiago Olivoto"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
link-citations: true
bibliography: metanref.bib 
vignette: >
  %\VignetteIndexEntry{Utilities for data manipulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(comment = "")
```

The R package [`DT`](https://rstudio.github.io/DT/) was used to produce the tables of this vignette.

```{r warning = FALSE, message = FALSE}
library(metan)
library(DT) # Used to make the tables
# Function to make HTML tables
print_table <- function(table, rownames = FALSE, n = 5, ...){
datatable(table,
          rownames = rownames,
          extensions = 'Buttons',
          options = list(scrollX = TRUE, dom = 'Bfrtip',
                         buttons = c('copy', 'excel', 'pdf', 'print', 'colvis')), ...) %>%
    formatRound(columns = c(1:ncol(table)), digits = 3)
}

```


# Utilities for rows and columns
## Add columns and rows
The functions `add_cols()` and `add_rows()` can be used to add columns and rows, respectively to a data frame.

```{r message=FALSE, warning=FALSE}
add_cols(data_ge,
         ROW_ID = 1:420) %>% 
  print_table()

```

It is also possible to add a column based on existing data. Note that the arguments `.after` and `.before` are used to select the position of the new column(s). This is particularly useful to put variables of the same category together.

```{r}
add_cols(data_ge,
         GY2 = GY^2,
         .after = "GY") %>% 
  print_table()
```

## Select or remove columns and rows
The functions `select_cols()` and `select_rows()` can be used to select columns and rows, respectively from a data frame.

```{r}
select_cols(data_ge2, ENV, GEN) %>% print_table()
select_rows(data_ge2, 1:3)  %>% print_table()
```

Numeric columns can be selected quickly by using the function `select_numeric_cols()`. Non-numeric columns are selected with `select_non_numeric_cols()`

```{r}
select_numeric_cols(data_ge2) %>% print_table()
select_non_numeric_cols(data_ge2) %>% print_table()
```


To remove columns or rows, use `remove_cols()` and `remove_rows()`.
```{r}
remove_cols(data_ge2, ENV, GEN)  %>% print_table()
remove_rows(data_ge2, 1:2, 5:8) %>% print_table()
```


## Concatenating columns
The function `concatetate()` can be used to concatenate multiple columns of a data frame. It return a data frame with all the original columns in `.data` plus the concatenated variable, after the last column.


```{r}
concatenate(data_ge, ENV, GEN, REP) %>% print_table()
```

To drop the existing variables and keep only the concatenated column, use the argument `drop = TRUE`. To use `concatenate()` within a given function like `add_cols()` use the argument `pull = TRUE` to pull out the results to a vector.
```{r}
concatenate(data_ge, ENV, GEN, REP, drop = TRUE) %>%
  head(3) %>% 
  print_table()
concatenate(data_ge, ENV, GEN, REP, pull = TRUE) %>% head(3)
```


To check if a column exists in a data frame, use `column_exists()`

```{r}
column_exists(data_ge, "ENV")
```

## Getting levels
To get the levels and the size of the levels of a factor, the functions `get_levels()` and `get_level_size()` can be used.

```{r}
get_levels(data_ge, ENV)
get_level_size(data_ge, ENV)
```


# Utilities for numbers and strings
## Rounding whole data frames
The function `round_cols()`round a selected column or a whole data frame to the specified number of decimal places (default 0). If no variables are informed, then all numeric variables are rounded.

```{r}
datatable(data_ge2,
          extensions = 'FixedColumns',
          options = list(scrollX = TRUE, fixedColumns = TRUE))
round_cols(data_ge2) %>% 
  datatable(extensions = 'FixedColumns',
          options = list(scrollX = TRUE, fixedColumns = TRUE))
```

Alternatively, select variables to round.
```{r}
round_cols(data_ge2, PH, EP, digits = 1)  %>% 
  datatable(extensions = 'FixedColumns',
          options = list(scrollX = TRUE, fixedColumns = TRUE))
```

## Extracting and replacing numbers

The functions `extract_number()`, and `replace_number()` can be used to extract or replace numbers. As an example, we will extract the number of each genotype in `data_g`. By default, the extracted numbers are put as a new variable called `new_var` after the last column of the data.

```{r}
extract_number(data_ge, GEN) %>% print_table()
```

If the argument `drop` is set to `TRUE` then, only the new variable is kept and all others are dropped.

```{r}
extract_number(data_ge, GEN, drop = TRUE) %>% print_table()
```

To pull out the results into a vector, use the argument `pull = TRUE`. This is particularly useful when `extract_*` or `replace_*` are used within a function like `mutate()`.


```{r}
extract_number(data_ge, GEN, pull = TRUE)
```

To replace numbers of a given column with a specified replacement, use `replace_number()`. By default, numbers are replaced with "". The argument `drop` and `pull` can also be used, as shown above.

```{r}
replace_number(data_ge, GEN) %>% print_table()
replace_number(data_ge,
               var = REP,
               pattern = "1",
               replacement = "Rep_1",
               new_var = R_ONE) %>% 
  print_table()
```

## Extracting and replacing strings
The functions `extract_string()`, and `replace_string()` are used in the same context of `extract_number()`, and `replace_number()`, but for handling with strings.

```{r}
extract_string(data_ge, GEN) %>% print_table()
```

To replace strings, we can use the function `replace_strings()`.
```{r}
replace_string(data_ge,
               var = GEN,
               new_var = GENOTYPE,
               replacement = "GENOTYPE_") %>% 
  print_table()
```


