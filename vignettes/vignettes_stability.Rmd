---
title: "Parametric and non-parametric stability statistics"
always_allow_html: yes
output: rmarkdown::html_vignette
fig_caption: yes
link-citations: true
bibliography: metanref.bib    
vignette: >
  %\VignetteIndexEntry{Parametric and non-parametric stability statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r global_options, include = FALSE}
knitr::opts_chunk$set(comment = "")

```


# Getting started

In this section, we will use the data in `data_ge` and `data_ge2`. For more information see `?data_ge` and `?data_ge2`, respectively. Other data sets can be used provided that the following columns are in the data_ge: environment, genotype, block/replicate and response variable(s).

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
library(metan)
library(cowplot) # used to arrange the graphics
library(kableExtra) # Used to make the tables
library(tidyverse) # for data manipulation and pipe %>%
# Function to make HTML tables
print_table = function(table){
  kable(table, "html", digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
}
str(data_ge)
```

# Graphic visualization of the interaction
The function `ge_plot()` may be used to visualize the genotype's performance across the environments. The black diamond shows the mean of each environment.
```{r, fig.width=10, fig.height=5, warning = FALSE, message = FALSE}
p1 = ge_plot(data_ge, ENV, GEN, GY)
p2 = ge_plot(data_ge, ENV, GEN, GY) + theme_grey() + coord_flip()
plot_grid(p1, p2)
```

# Clustering tester locations

The function `ge_cluster()` computes a cluter analysis for grouping environments based on its similarities using an Euclidean distance based on standardized data. Line means are divided by the phenotypic standard error of the relevant environment after its mean has been subtracted. By standardizing the data each environment will have a mean of zero and unit variance, and the effect of variability in phenotypic variance (as well as the mean) should be reduced [@Fox1982].

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE, fig.align="center"}
d1 = ge_cluster(data_ge, ENV, GEN, GY, nclust = 4)
plot(d1, nclust = 4)

```


# Joint regression analysis
@Eberhart1966 popularized the regression-based stability analysis. In these procedures, the adaptability and stability analysis is performed by means of adjustments of regression equations where the dependent variable is predicted as a function of an environmental index, according to the following model:

$$
\mathop Y\nolimits_{ij}  = {\beta _{0i}} + {\beta _{1i}}{I_j} + {\delta _{ij}} + {\bar \varepsilon _{ij}}
$$
where ${\beta _{0i}}$ is the grand mean of the genotype *i* (*i* = 1, 2, ..., I); ${\beta _{1i}}$ is the linear response (slope) of the genotype *i* to the environmental index; *Ij* is the environmental index (*j* = 1, 2, ..., *e*), where ${I_j} = [(y_{.j}/g)- (y_{..}/ge)]$, ${\delta _{ij}}$ is the deviation from the regression, and ${\bar \varepsilon _{ij}}$ is the experimental error.
The model is fitted with the function `ge_reg()`. The S3 methods `plot()` and `summary()` may be used to explore the fitted model.

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
reg_model = ge_reg(data_ge, ENV, GEN, REP, GY)
print_table(reg_model$GY$anova)
print_table(reg_model$GY$regression)

```


# Genotypic confidence index
@Annicchiarico1992 proposed a stability method in which the stability parameter is measured by the superiority of the genotype in relation to the average of each environment, according to the following model:

$$
{Z_{ij}} = \frac{{{Y_{ij}}}}{{{{\bar Y}_{.j}}}} \times 100
$$
The genotypic confidence index of the genotype *i* ($W_i$) is then estimated as follows:

$$
W_i = Z_{i.}/e - \alpha \times sd(Z_{i.})
$$
Where $\alpha$ is the quantile of the standard normal distribution at a given probability error ($\alpha \approx 1.64$ at 0.05). The method is implemented using the function `Annicchiarico()`. The confidence index is estimated considering all environment, favorable environments (positive index) and unfavorable environments (negative index), as follows:

## Computing the index

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
ann5 = Annicchiarico(data_ge, ENV, GEN, REP, GY)
ann1 = Annicchiarico(data_ge, ENV, GEN, REP, GY, prob = 0.01)


```

## Environment classification

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
df = ann5$GY
kable(df$environments, "html", digits = 3) %>% 
row_spec(which(df$environments$index <0), bold = T, color = "white", background = "red") %>%
row_spec(which(df$environments$index >0), bold = T, color = "white", background = "green") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```

## Index computed with all environments

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
kable(df$general, "html", digits = 3) %>% 
row_spec(2, bold = T, color = "white", background = "red") %>%
row_spec(4, bold = T, color = "white", background = "green") %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```


# Superiority index
The function `superiority()` implements the nonparametric method proposed by @Lin1988, which considers that a measure of cultivar general superiority for cultivar x location data is defined as the distance mean square between the cultivar's response and the maximum response averaged over all locations, according to the following model.

$$
P_i = \sum\limits_{j = 1}^n{(y_{ij} - y_{.j})^2/(2n)}
$$
where *n* is the number of environments

Similar then the genotypic confidence index, the superiority index is calculated by all environments, favorable, and unfavorable environments.

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
super = superiority(data_ge, ENV, GEN, REP, GY)

kable(super$GY$index, "html", digits = 3) %>% 
  row_spec(2, bold = T, color = "white", background = "red") %>%
  row_spec(4, bold = T, color = "white", background = "green") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```


# Environmental stratification
A method that combines stability analysis and environmental stratification using factor analysis was proposed by @murakami2004. This method is implemented with the function `ge_factanal()`, as follows:

```{r, fig.width=5, fig.height=4, warning = FALSE, message = FALSE}
fact = ge_factanal(data_ge, ENV, GEN, REP, GY)
plot(fact$GY)
print_table(fact$GY$PCA)
print_table(fact$GY$FA)
print_table(fact$GY$env_strat)



```


The easiest way to compute the above-mentioned stability indexes is by using the function `ge_stats()`. This function basically returns a summary of each method. If you are looking for more details from each method, like plot() and summary(), I suggest computing that methods using their own function.

# Computing the indexes

```{r }
stat_ge <- data_ge %>% ge_stats(ENV, GEN, REP, GY)
dat = stat_ge$GY
```
If you whant to export a summary of results, the simplest way is by using the function summary, as follows:


```{r, eval=FALSE }
summary(stat_ge, export = TRUE)
```
This comand will create a text file called *ge_stats summary.txt* in the current working directory.


# Within-environment analysis of variance
The following table shows the results for the analysis of variance in each environment. Environment with a gray background had a significant genotype effect, considering 5% probability error.
```{r }
kable(dat$individual, "html", digits = 3) %>% 
  row_spec(which(dat$individual$PRFG < 0.05), bold = T, color = "white", background = "gray80") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```

# Genotype-by-environment means
The two-way table with the means for each genotype in each environment is stored into `ge_mean`. The following code creates a custom table highlighting with a red background the genotype with the lowest mean in each environment, and with a green background the genotype with the highest mean.

```{r }
round(dat$ge_mean, 2) %>%
rownames_to_column('gen') %>% # used to store row names (mutate deletes them)
mutate_if(is.numeric, function(x){
  cell_spec(x, "html",
            color = case_when(x == max(x) ~ "white",
                              x == min(x) ~ "white",
                              TRUE ~ "black"),
            background  = case_when(x == max(x) ~ "green",
                                    x == min(x) ~ "red",
                                    TRUE ~ "transparent"))
}) %>%
column_to_rownames('gen') %>% # used to put row names back in place
kable("html", digits = 3, escape = F) %>%
kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```


# Genotype-by-environment interaction effects
Highlighting with a red background the genotypes with negative interaction effects within each environment
```{r }
round(dat$ge_effect, 2) %>%
  rownames_to_column('gen') %>% # used to store row names (mutate deletes them)
  mutate_if(is.numeric, function(x){
    cell_spec(x, "html",
              color = ifelse(x < 0, "white", "black"),
              background  = ifelse(x < 0, "red", "transparent"))
  }) %>%
  column_to_rownames('gen') %>% # used to put row names back in place
  kable("html", digits = 3, escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)

```

# Genotype plus Genotype-by-environment effects
```{r }
round(dat$gge_effect, 2) %>%
  rownames_to_column('gen') %>% # used to store row names (mutate deletes them)
  mutate_if(is.numeric, function(x){
    cell_spec(x, "html",
              color = ifelse(x < 0, "white", "black"),
              background  = ifelse(x < 0, "red", "transparent"))
  }) %>%
  column_to_rownames('gen') %>% # used to put row names back in place
  kable("html", digits = 3, escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 12)
```


# References

