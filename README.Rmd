---
always_allow_html: yes
output: github_document

---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#",
  fig.path = "man/figures/README-"
)
```


# metan <img src="man/figures/logo.png" align="right" height=140/>
<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/metan)](https://CRAN.R-project.org/package=metan)
[![CRAN Checks](https://cranchecks.info/badges/summary/metan)](https://cran.r-project.org/web/checks/check_results_metan.html)
[![Lifecycle: stable](https://img.shields.io/badge/lifecycle-stable-brightgreen.svg)](https://www.tidyverse.org/lifecycle/#stable)
[![Downloads](http://cranlogs.r-pkg.org/badges/metan)](https://CRAN.R-project.org/package=metan)
[![Total Downloads](https://cranlogs.r-pkg.org/badges/grand-total/metan?color=orange)](https://cran.r-project.org/package=metan)
[![DOI](https://zenodo.org/badge/DOI/10.5281/zenodo.3663097.svg)](https://doi.org/10.5281/zenodo.3663097)
<!-- badges: end -->



The metan (**m**ulti-**e**nvironment **t**rials **an**alysis) package provides useful functions for analyzing multi-environment trial data using parametric and nonparametric methods. The package will help you to:

* Inspect data for possible common errors;
* Manipulate rows and columns;
* Manipulate numbers and strings;
* Compute descriptive statistics;
* Compute within-environment analysis of variance;
* Compute AMMI analysis with prediction considering different numbers of interaction principal component axes;
* Compute AMMI-based stability indexes;
* Compute GGE biplot analysis;
* Compute BLUP-based stability indexes;
* Compute variance components and genetic parameters in mixed-effect models;
* Perform cross-validation procedures for AMMI-family and BLUP models;
* Compute parametric and nonparametric stability statistics
* Implement biometrical models

For more details see the [complete vignette](https://tiagoolivoto.github.io/metan/).

# Installation

Install the released version of metan from [CRAN](https://CRAN.R-project.org/package=metan) with:

```{r, eval=FALSE}
install.packages("metan")

```

Or install the development version from [GitHub](https://github.com/TiagoOlivoto/metan) with:

```{r, eval=FALSE}
devtools::install_github("TiagoOlivoto/metan")

# To build the HTML vignette use
devtools::install_github("TiagoOlivoto/metan", build_vignettes = TRUE)

```


*Note*: If you are a Windows user, you should also first download and install the latest version of [Rtools](https://cran.r-project.org/bin/windows/Rtools/).

For the latest release notes on this development version, see the [NEWS file](https://tiagoolivoto.github.io/metan/news/index.html).


# Getting started

Here, we will use the example dataset `data_ge` that contains data on two variables assessed in 10 genotypes growing in 14 environments. For more details see `?data_ge`.

```{r, message=FALSE, warning=FALSE}
library(metan)

```

The first step is to inspect the data with the function [`inspect()`](https://tiagoolivoto.github.io/metan/reference/inspect.html).

```{r, fig.width=7, fig.height=7, fig.align="center"}
inspect(data_ge, plot = TRUE)
```

No issues while inspecting the data. Let's continue with the analyzes!

# Descriptive statistics
`metan` provides [a set of functions](https://tiagoolivoto.github.io/metan/reference/utils_stats.html) to compute descriptive statistics. The easiest way to do that is by using `desc_stat()`.

```{r}
desc_stat(data_ge2)
```

# AMMI model
## Fitting the model
The AMMI model is fitted with the function [`performs_ammi()`](https://tiagoolivoto.github.io/metan/reference/performs_ammi.html). To analyze multiple variables at once we can use a comma-separated vector of unquoted variable names, or use any select helper in the argument `resp`. Here, using `everything()` we apply the function to all numeric variables in the data. For more details, see the [complete vignette](https://tiagoolivoto.github.io/metan/articles/vignettes_ammi.html).

```{r}
model <- performs_ammi(data_ge,
                       env = ENV,
                       gen = GEN,
                       rep = REP,
                       resp = everything(),
                       verbose = FALSE)
```


## Predicting the response variable
The S3 method [`predict()`](https://tiagoolivoto.github.io/metan/reference/predict.performs_ammi.html) is implemented for objects of class [`performs_ammi`](https://tiagoolivoto.github.io/metan/reference/performs_ammi.html) and may be used to estimate the response of each genotype in each environment considering different number of Interaction Principal Component Axis (IPCA). As a example, to predict the variables GY and HM we will use four and six IPCA (number of significant IPCAs, respectively).

```{r message=FALSE,warning=FALSE }
pred <- predict(model, naxis = c(4, 6))
pred$GY

```


## Biplots

The well-known AMMI1 and AMMI2 biplots can be created with [`plot_scores()`](file:///D:/Desktop/metan/docs/reference/plot_scores.html). Note that since [`performs_ammi`](https://tiagoolivoto.github.io/metan/reference/performs_ammi.html) allows analyzing multiple variables at once, e.g., `resp = c(v1, v2, ...)`, the output `model` is a list, in this case with two elements (GY and HM). By default, the biplots are created for the first variable of the model. To choose another variable use the argument `var` (e.g., `var = "HM"`).

```{r AMMI, fig.width=15, fig.height=5, message=FALSE, warning=FALSE}
a <- plot_scores(model)
b <- plot_scores(model,
                 type = 2,
                 polygon = TRUE,
                 col.env = "gray70",
                 col.segm.env = "gray70",
                 axis.expand = 1.5)
c <- plot_scores(model, type = 4)
arrange_ggplot(a, b, c, labels = letters[1:3], nrow = 1)

```



# GGE model
The GGE model is fitted with the function [`gge()`](https://tiagoolivoto.github.io/metan/reference/gge.html). For more details, see the [complete vignette](https://tiagoolivoto.github.io/metan/articles/vignettes_gge.html).


```{r GGE, fig.width=15, fig.height=5, message=FALSE, warning=FALSE}
model <- gge(data_ge, ENV, GEN, GY)
model2 <- gge(data_ge, ENV, GEN, GY, svp = "genotype")
model3 <- gge(data_ge, ENV, GEN, GY, svp = "symmetrical")
d <- plot(model)
e <- plot(model2, type = 8)
f <- plot(model2,
          type = 2,
          col.gen = "black",
          col.env = "gray70",
          axis.expand = 1.5)
arrange_ggplot(d, e, f, labels = letters[4:6], nrow = 1)

```



# BLUP model
Linear-mixed effect models to predict the response variable in METs are fitted using the function [`waasb()`](https://tiagoolivoto.github.io/metan/reference/waasb.html). Here we will obtain the predicted means for genotypes in the variables `GY` and `HM`. For more details, see the [complete vignette](https://tiagoolivoto.github.io/metan/articles/vignettes_blup.html).

```{r }
model2 <- waasb(data_ge,
                env = ENV,
                gen = GEN,
                rep = REP,
                resp = everything())
# Get the variance components
get_model_data(model2, what = "vcomp")

# Get the genetic parameters
get_model_data(model2, what = "genpar")

```


## Plotting the BLUPs for genotypes

To produce a plot with the predicted means, use the function `plot_blup()`.

```{r BLUP, fig.width=10, fig.height=5, message=FALSE, warning=FALSE}
g <- plot_blup(model2)
h <- plot_blup(model2,
               prob = 0.1,
               col.shape  =  c("gray20", "gray80")) + ggplot2::coord_flip()
arrange_ggplot(g, h, labels = letters[7:8])

```


## Random effects

The object `BLUPint` contains the random effects of the model. We can get the values with:
```{r }
get_model_data(model2, "ranef")
```

When more than one variable is fitted, the predicted means for genotype-vs-environment combination may be obtained for all variables in the model using [`predict()`](https://tiagoolivoto.github.io/metan/reference/predict.waasb.html).

```{r }
predict(model2)

```


# Computing parametric and non-parametric stability indexes

```{r}
stats <- ge_stats(data_ge, ENV, GEN, REP, GY)
get_model_data(stats, "stats")
get_model_data(stats, "ranks")
```

# Citation

```{r, comment=""}
citation("metan")
```

  
# Getting help

* If you encounter a clear bug, please file a minimal reproducible example on [github](https://github.com/TiagoOlivoto/metan/issues)

* Suggestions and criticisms to improve the quality and usability of the package are welcome!



